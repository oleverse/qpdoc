{% extends "base.html" %}
{% block title %}
    <title>{{ title }}</title>
{% endblock %}
{% block style_file %}
    <link rel="stylesheet" href="{{ url_for('static', path='/css/chat.css') }}">
{% endblock %}
{% block content %}
    <div class="container">

        <div class="leftbox">
            <form action="/upload" method="post" id="uploadForm" enctype="multipart/form-data" class="add-pdf" >
                <input type="file" id="file-input" name="files" accept=".pdf, .docx, .odt" multiple>
                <label for="file-input">
                    <i class="fa-solid fa-arrow-up-from-bracket"></i>
                    &nbsp; Choose PDF
                </label>
                <div id="num-of-files">No Files Coosen</div>
                <ul id="files-list"></ul>
            </form>
        </div>

        <div class="rightbox">
            <div class="msgs" id="subscribe">
            </div>

            <div class="typing-box">
                <form id="formChat" class="send">
                    <input type="text" id="question"
                    class="input-field"
                    placeholder="What do you want to know..."
                    autocomplete="off">
                    <button type="submit" class="send-btn">
                        <i class="fa-solid fa-circle-arrow-up"></i>
                    </button>
                </form>
            </div>
        </div>

    </div>
    
    <!-- SCRIPT FOR FILE BAR -->
    <script>
        let fileInput = document.getElementById("file-input");
        let fileList = document.getElementById("files-list");
        let numOfFiles = document.getElementById("num-of-files");

        fileInput.addEventListener("change", () => {
            fileList.innerHTML = "";
            numOfFiles.textContent = `${fileInput.files.length}
            Files Selected`;

            for (i of fileInput.files) {
                let reader = new FileReader();
                let listItem = document.createElement("li");
                let fileName = i.name;
                fileSize = (i.size / 1024).toFixed(1);
                listItem.innerHTML = `<p>${fileName}</p><p>${fileSize}KB</p>`;

                if (fileSize >= 1024) {
                    fileSize = (fileSize / 1024).toFixed(1);
                    listItem.innerHTML = `<p>${fileName}</p><p>${fileSize}MB</p>`;
                }
                fileList.appendChild(listItem);
            }

            uploadForm.submit()
        });

        /* script for chatting via websocket */
        console.log('Starting the chat!')

        function startWebsocket() {
            let ws = null
            try {
                ws = new WebSocket('ws://{{ ws_address }}')
            } catch (err) {
                console.log('Failed to connect to the ws endpoint, retrying...')
                return
            }

            function submitForm(e) {
                e.preventDefault()

                if (question.value) {
                    ws.send('{"user_id": {{user_id}}, "message": "' + question.value + '"}')
                    const elMsg = document.createElement('div')
                    elMsg.setAttribute('class', 'user-msg')
                    elMsg.innerHTML = "<p>" + question.value + "</p>"
                    subscribe.appendChild(elMsg)
                    question.value = null
                    subscribe.scrollTo({
                        top: subscribe.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }

            ws.onopen = (e) => {
                console.log('Chat communication intitialized!')

                const elMsg = document.createElement('div')
                elMsg.setAttribute('class', 'info-msg')
                elMsg.innerHTML = "<p>We're online, let's talk!</p>"
                subscribe.appendChild(elMsg)
                subscribe.style.border = "none"
                subscribe.scrollTo({
                    top: subscribe.scrollHeight,
                    behavior: 'smooth'
                });

                formChat.addEventListener('submit', submitForm)
                formChat.getElementsByClassName("send-btn")[0].disabled = false;
                question.readOnly = false;
                question.setAttribute("placeholder", "What do you want to know...")
                document.getElementsByClassName("typing-box")[0].style.borderColor = "#4b5eb8"
            }

            ws.onmessage = (e) => {
                console.log(e.data)
                data = JSON.parse(e.data);
                const elMsg = document.createElement('div')
                elMsg.setAttribute('class', 'bot-msg')
                elMsg.innerHTML = "<p>" + data.message + "</p>"

                if (data.code == 403) {
                    elMsg.innerHTML += " Redirecting in 3 secs..."
                    setTimeout(() => {document.location = "/login"}, 3000)
                }

                subscribe.appendChild(elMsg)
                subscribe.scrollTo({
                    top: subscribe.scrollHeight,
                    behavior: 'smooth'
                });
            }

            ws.onclose = () => {
                formChat.removeEventListener('submit', submitForm)
                formChat.getElementsByClassName("send-btn")[0].disabled = true;
                question.readOnly = true
                question.setAttribute("placeholder", "No connection, chat is disabled...")
                document.getElementsByClassName("typing-box")[0].style.borderColor = "#ba0000"
                const elMsg = document.createElement('div')
                elMsg.setAttribute('class', 'info-msg')
                elMsg.innerHTML = "<p>Connection lost, reconnecting in 5 secs...</p>"
                subscribe.appendChild(elMsg)
                subscribe.style.border = "2px solid #ba0000"
                subscribe.scrollTo({
                    top: subscribe.scrollHeight,
                    behavior: 'smooth'
                });
                setTimeout(startWebsocket, 5000)
            }
        }

        startWebsocket()

    </script>
{% endblock %}