{% extends "base.html" %}
{% block title %}
    <title>{{ title }}</title>
{% endblock %}
{% block style_file %}
    <link rel="stylesheet" href="{{ url_for('static', path='/css/chat.css') }}">
{% endblock %}
{% block content %}
    <div class="container">

        <div class="leftbox">
            <form action="#" class="add-pdf">
                <input type="file" id="file-input" multiple>
                <label for="file-input">
                    <i class="fa-solid fa-arrow-up-from-bracket"></i>
                    &nbsp; Choose PDF
                </label>
                <div id="num-of-files">No Files Coosen</div>
                <ul id="files-list"></ul>
            </form>
        </div>

        <div class="rightbox">
            <div class="msgs" id="subscribe">
            </div>

            <div class="typing-box">
                <form id="formChat" class="send">
                    <input type="text" id="question"
                    class="input-field"
                    placeholder="What do you want to know..."
                    autocomplete="off">
                    <button type="submit" class="send-btn">
                        <i class="fa-solid fa-circle-arrow-up"></i>
                    </button>
                </form>
            </div>
        </div>

    </div>
    
    <!-- SCRIPT FOR FILE BAR -->
    <script>
        let fileInput = document.getElementById("file-input");
        let fileList = document.getElementById("files-list");
        let numOfFiles = document.getElementById("num-of-files");

        fileInput.addEventListener("change", () => {
            fileList.innerHTML = "";
            numOfFiles.textContent = `${fileInput.files.length}
            Files Selected`;

            for (i of fileInput.files) {
                let reader = new FileReader();
                let listItem = document.createElement("li");
                let fileName = i.name;
                fileSize = (i.size / 1024).toFixed(1);
                listItem.innerHTML = `<p>${fileName}</p><p>${fileSize}KB</p>`;

                if (fileSize >= 1024) {
                    fileSize = (fileSize / 1024).toFixed(1);
                    listItem.innerHTML = `<p>${fileName}</p><p>${fileSize}MB</p>`;
                }
                fileList.appendChild(listItem);
            }
        });

        /* script for chatting via websocket */
        console.log('Starting the chat!')

        function startWebsocket() {
            let ws = null
            try {
                ws = new WebSocket('ws://{{ ws_address }}')
            } catch (err) {
                console.log('Failed to connect to the ws endpoint, retrying...')
                return
            }

            ws.onopen = (e) => {
                console.log('Chat communication intitialized!')

                formChat.addEventListener('submit', (e) => {
                    e.preventDefault()
                    ws.send(question.value)

                    const elMsg = document.createElement('div')
                    elMsg.setAttribute('class', 'user-msg')
                    elMsg.innerHTML = "<p>" + question.value + "</p>"
                    subscribe.appendChild(elMsg)
                    question.value = null
                    subscribe.scrollTo({
                        top: subscribe.scrollHeight,
                        behavior: 'smooth'
                    });
                })
            }

            ws.onmessage = (e) => {
                // console.log(e.data)
                text = e.data

                const elMsg = document.createElement('div')
                elMsg.setAttribute('class', 'bot-msg')
                elMsg.innerHTML = "<p>" + text + "</p>"
                subscribe.appendChild(elMsg)
                subscribe.scrollTo({
                    top: subscribe.scrollHeight,
                    behavior: 'smooth'
                });
            }

            ws.onclose = () => {
                setTimeout(startWebsocket, 5000)
            }
        }

        startWebsocket()

    </script>
{% endblock %}